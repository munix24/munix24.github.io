<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoL Champion Fight Simulation</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            height: 100vh;
            margin: 0;
            padding: 0;
            /* background-image: url('https://github.com/InFinity54/LoL_DDragon/blob/master/extras/loadingscreen/basictutorial_loadingscreen.png');   3rd prty cookie*/
            /* background-image: url('https://raw.communitydragon.org/14.3/game/assets/characters/aatrox/skins/skin01/aatroxloadscreen_1.png');  */
            /* background-image: url('tutorialfirstmodule_loadingscreen.png'); */
            background-size: cover; /* Adjust background size as needed */
            background-position: center; /* Center the background image */
        }

        .container {
            display: flex;
            width: 100%;
            align-content: center;
        }

        .column {
            min-width: 280px;
            flex: 1;
            margin: 0px 0px 20px;
            text-align: center;
            justify-content: center;
            display: flex;
            flex-direction: column;
        }

        .column-top {
            text-align: center;
            flex: 3;
            display: flex;
            flex-direction: column;
        }

        .column-mid {
            height: 100%;
        }

        .column-bottom {
            text-align: center;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .fight {
            text-align: center;
            flex: 3;
            border: 1px solid black;
            padding: 10px;
            display: flex;
            flex-direction: column;
            width: 50%;                 /* doesn't matter what size is set to it just works */
        }

        .fight-top, .fight-bottom {
            overflow: auto;
        }

        .fight-top {
            flex: 5;
            border-bottom: 1px solid black;
        }

        .fight-bottom {
            flex: 1;
        }

        h1 {margin-top: 0; margin-bottom: 0;}
        h2 {margin-top: 0; margin-bottom: 0;}
        h3 {margin-top: 0; margin-bottom: 0;}

        .clickable {
            cursor: default;
            color: blue;
        }

        table {
            text-align: center;
            border-spacing: 0;
            table-layout: fixed;
            width: 100%; /* Set the table width to fill its container */
        }

        thead th {
            width: 50px; 
            position: sticky;
            top: 0; /* Stick to the top */
            background-color: white; /* set to table bg color or it will overlap with data when scrolling */
        }

        tbody th {
            text-align: left;
            /* outline: 1px solid #ccc;
            outline-offset: -1px; */
            width: 75px; /* a little longer on the side*/
            position: sticky;
            left: 0;
            background-color: white; /* set to table bg color or it will overlap with data when scrolling */
        }

        th {
            max-width: 60px; 
            overflow: hidden;
            text-overflow: ellipsis; /* Truncate text with an ellipsis */
            white-space: nowrap; /* Prevent text from wrapping */
        }

        tr {
            line-height: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="column" style="text-align: left;">
            <div class="column-top">
                <p><h1>Champion 1</h1></p>

                <div>
                    <label for="champion1">Select Champion:</label>
                    <select id="champion1">
                        <!-- Champions will be populated dynamically with JavaScript -->
                    </select>
                    <label for="levelSelect1">Lvl:</label>
                    <select id="levelSelect1">
                    </select>
                    <p>
                </div>
            </div>

            <div id="championSplash1" class="column-mid"></div>
            <div id="championStats1" class="column-bottom"></div>
        </div>

        <div class="fight">
            <div class="fight-top" id="fightSimulation"></div>
            <div class="fight-bottom" id="fightActions"></div>
        </div>

        <div class="column">
            <div class="column-top">
                <p><h1>Champion 2</h1></p>

                <div>
                    <label for="champion2">Select Champion:</label>
                    <select id="champion2">
                        <!-- Champions will be populated dynamically with JavaScript -->
                    </select>
                    <label for="levelSelect2">Lvl:</label>
                    <select id="levelSelect2">
                    </select>
                    <p>
                </div>
            </div>

            <div id="championSplash2" class="column-mid"></div>
            <div id="championStats2" class="column-bottom"></div>
        </div>
    </div>

    <script src="Champ.js"></script>
    <script src="champion.js"></script>
    <script>
        // Function to populate the dropdowns with champions
        async function populateChampions() {
            const championData = window.json.data; // Assuming champion data is in a global variable
            const champion1Select = document.getElementById('champion1');
            const champion2Select = document.getElementById('champion2');

            // Populate options for both dropdowns
            for (const championName in championData) {
                const option1 = document.createElement('option');
                option1.value = championName;
                option1.textContent = championName;
                const option2 = option1.cloneNode(true);
                champion1Select.appendChild(option1);
                champion2Select.appendChild(option2);
            }

            // Populate the level select box
            const levelSelect1 = document.getElementById('levelSelect1');
            const levelSelect2 = document.getElementById('levelSelect2');
            for (let level = 1; level <= 18; level++) {
                const option1 = document.createElement('option');
                option1.value = level;
                option1.textContent = level;
                const option2 = option1.cloneNode(true);
                levelSelect1.appendChild(option1);
                levelSelect2.appendChild(option2);
            }

            // Add event listeners to both selects to display stats and simulate fight
            champion1Select.addEventListener('change', displayStatsAndFight);
            champion2Select.addEventListener('change', displayStatsAndFight);

            displayStatsAndFight();
        }

        // Function to display the stats of selected champions
        async function displayStats(championStatsDiv, champion) {
            championStatsDiv.innerHTML = `
                <h2>${champion.name}</h2>
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>Stat</th>
                            <th>Per Lvl</th>
                        </tr>  
                    </thead>      
                    <tr>
                        <td><strong>HP</strong></td>
                        <td>${champion.stats.hp != 0 ? champion.stats.hp : ''}</td>
                        <td>${champion.stats.hpperlevel != 0 ? champion.stats.hpperlevel : ''}</td>
                    </tr>
                    <tr>
                        <td><strong>MP</strong></td>
                        <td>${champion.stats.mp != 0 ? champion.stats.mp : ''}</td>
                        <td>${champion.stats.mpperlevel != 0 ? champion.stats.mpperlevel : ''}</td>
                    </tr>
                    <tr>
                        <td><strong>Move Speed</strong></td>
                        <td>${champion.stats.movespeed != 0 ? champion.stats.movespeed : ''}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td><strong>Armor</strong></td>
                        <td>${champion.stats.armor != 0 ? champion.stats.armor : ''}</td>
                        <td>${champion.stats.armorperlevel != 0 ? champion.stats.armorperlevel : ''}</td>
                    </tr>
                    <tr>
                        <td><strong>Magic Resist</strong></td>
                        <td>${champion.stats.spellblock != 0 ? champion.stats.spellblock : ''}</td>
                        <td>${champion.stats.spellblockperlevel != 0 ? champion.stats.spellblockperlevel : ''}</td>
                    </tr>
                    <tr>
                        <td><strong>Attack Range</strong></td>
                        <td>${champion.stats.attackrange != 0 ? champion.stats.attackrange : ''}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td><strong>HP Regen</strong></td>
                        <td>${champion.stats.hpregen != 0 ? champion.stats.hpregen : ''}</td>
                        <td>${champion.stats.hpregenperlevel != 0 ? champion.stats.hpregenperlevel : ''}</td>
                    </tr>
                    <tr>
                        <td><strong>MP Regen</strong></td>
                        <td>${champion.stats.mpregen != 0 ? champion.stats.mpregen : ''}</td>
                        <td>${champion.stats.mpregenperlevel != 0 ? champion.stats.mpregenperlevel : ''}</td>
                    </tr>
                    <tr>
                        <td><strong>Crit</strong></td>
                        <td>${champion.stats.crit != 0 ? champion.stats.crit : ''}</td>
                        <td>${champion.stats.critperlevel != 0 ? champion.stats.critperlevel : ''}</td>
                    </tr>
                    <tr>
                        <td><strong>Atk Damage</strong></td>
                        <td>${champion.stats.attackdamage != 0 ? champion.stats.attackdamage : ''}</td>
                        <td>${champion.stats.attackdamageperlevel != 0 ? champion.stats.attackdamageperlevel : ''}</td>
                    </tr>
                    <tr>
                        <td><strong>Atk Speed</strong></td>
                        <td>${champion.stats.attackspeed != 0 ? champion.stats.attackspeed : ''}</td>
                        <td>${champion.stats.attackspeedperlevel != 0 ? champion.stats.attackspeedperlevel : ''}</td>
                    </tr>
                </table>
            `;
                    // ${Object.entries(champion.stats).map(([stat, value]) => `
                    //         ${!stat.includes('perlevel') && !stat.includes('attackspeed')  ? `<tr><td><b>${stat}</b></td><td>${value !== 0 ? value : ''}</td>` : ''}
                    //         ${stat.includes('perlevel') && !stat.includes('attackspeed')  ? `<td>${value !== 0 ? value : ''}</td>` : ''}
                    // `).join('')}
                    // <tr><td><b>attackspeed</b></td><td>${champion.stats.attackspeed}</td><td>${champion.stats.attackspeedperlevel}</td>
        }

        // Function to display the stats of selected champions and simulate fight
        async function displayStatsAndFight() {
            const champion1Name = document.getElementById('champion1').value;
            const champion2Name = document.getElementById('champion2').value;
            const champion1level = document.getElementById('levelSelect1').value; 
            const champion2level = document.getElementById('levelSelect2').value; 

            const champion1 = new Champ(champion1Name, champion1level);
            const champion2 = new Champ(champion2Name, champion2level);

            displayStats(document.getElementById('championStats1'), champion1);
            displayStats(document.getElementById('championStats2'), champion2);

            cc_url='https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/assets/characters/';
            // cc_url='https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/assets/characters/aatrox/skins/base/';
            cc_url1=`${cc_url}${champion1Name.toLowerCase()}/skins/base/${champion1Name.toLowerCase()}loadscreen.jpg`;
            cc_url2=`${cc_url}${champion2Name.toLowerCase()}/skins/base/${champion2Name.toLowerCase()}loadscreen.jpg`;
            // console.log(cc_url1);
            document.getElementById('championSplash1').style.backgroundImage = `url(${cc_url1})`;
            document.getElementById('championSplash2').style.backgroundImage = `url(${cc_url2})`;
            
            // Simulate fight
            const fightActionsDiv = document.getElementById('fightActions');
            fightActionsDiv.innerHTML = ''; // Clear previous fight actions

            const { winner, remainingHp } = await simulateFight(champion1, champion2, fightActionsDiv, true);
            fightActionsDiv.innerHTML += `<h3>${winner.name} wins with ${remainingHp} HP remaining!</h3>`;

            // Scroll to the bottom of the container
            fightActionsDiv.scrollTop = fightActionsDiv.scrollHeight;
        }

        // Function to simulate the fight between two champions
        async function simulateFight(champion1, champion2, fightActionsDiv, instant = true) {
            return new Promise(resolve => {
                const attackQueue = [{ time: 0, attacker: champion1, attacked: champion2 }, { time: 0, attacker: champion2, attacked: champion1 }];
                attackQueue.sort((a, b) => a.time - b.time);

                if (instant) {
                    while (attackQueue.length && !champion1.isDefeated() && !champion2.isDefeated()) {
                        const { time, attacker, attacked } = attackQueue.shift();
                        attacker.attack(attacked);
                        if (fightActionsDiv) 
                            fightActionsDiv.innerHTML += `${time.toFixed(2)}s: ${attacked.name} took ${attacker.attackdamage} damage. ${attacked.name}'s HP: ${attacked.hp}<br>`;
                        
                        attackQueue.push({ time: attacker.attack_cd, attacker, attacked });
                        attackQueue.sort((a, b) => a.time - b.time);
                    }
                } else {
                    const interval = setInterval(() => {
                        if (!attackQueue.length || champion1.isDefeated() || champion2.isDefeated()) {
                            clearInterval(interval);
                        } else {
                            const { time, attacker, attacked } = attackQueue.shift();
                            attacker.attack(attacked);
                            if (fightActionsDiv) 
                                fightActionsDiv.innerHTML += `${time.toFixed(2)}s: ${attacked.name} took ${attacker.attackdamage} damage. ${attacked.name}'s HP: ${attacked.hp}<br>`;
                            attackQueue.push({ time: attacker.attack_cd, attacker, attacked });
                            attackQueue.sort((a, b) => a.time - b.time);
                        }
                    }, 1000);
                }

                winner=champion1.isDefeated() ? champion2 : champion1,
                remainingHp=champion1.isDefeated() ? champion2.hp : champion1.hp
                resolve({winner,remainingHp});
            });
        }

        async function selectedChampionFight(champion1, champion2){
            document.getElementById('champion1').value = champion1;
            document.getElementById('champion2').value = champion2;
            displayStatsAndFight();
        }

        // Function to populate the dropdowns with champions
        async function populateAllChampionsSimulateFight() {
            // Get the list of champions
            const champions = Object.keys(window.json.data);

            // Generate the table header with champion names
            let tableHTML = `<table><thead><tr><th></th>${champions.map(champion => `<th>${champion}</th>`).join('')}</tr></thead><tbody>`;

            // Simulate fights and fill in the table
            for (const champion1 of champions) {
                tableHTML += `<tr><th>${champion1}</th>`;
                for (const champion2 of champions) {
                    if (champion1 == champion2){
                        tableHTML += `<td>-</td>`;
                    } else {
                        const champ1 = new Champ(champion1, 1);
                        const champ2 = new Champ(champion2, 1);
                        const { winner, remainingHp } = await simulateFight(champ1, champ2);
                        tableHTML += `<td class="clickable" onclick="selectedChampionFight('${champion1}', '${champion2}')">${winner.name == champion1 ? 1 : 0}</td>`;
                    }
                }
                tableHTML += `</tr>`;
            }

            tableHTML += `</tbody></table>`;

            // Append the table to the fightSimulationDiv
            const fightSimulationDiv = document.getElementById('fightSimulation')
            fightSimulationDiv.innerHTML = tableHTML;
        }

        // Populate the dropdowns and simulate the fight when the page loads
        populateChampions();
        populateAllChampionsSimulateFight();
        // document.body.style.backgroundImage = "url('')";
    </script>
</body>
</html>